---
#title: "ecoEdChamps18_Tutorial_AusPlots"
#author: "Bernarndo Blanco-Martin"
#date: "9 December 2018"
output: html_document
---

\  

<center>
# ecoEd Champions 2018: Ecosystem Surveillance (AusPlots)
</center>
\  
<center>
## \"Understanding and using the 'ausplotsR' package and AusPlots data\"
</center>

\  
\  
\  


This document contains the "Ecosystem Surveillance (AusPlots): Understanding and using the 'ausplotsR' package and AusPlots data" tutorial for the ecoEd Champions Training 2018. In this tutorial we will explore the use of the package 'ausplotsR' & the 'ausplots' data that can be downloaded with this package. 

`ausplotsR` is an R package for live extraction and preparation of TERN AusPlots ecosystem monitoring data. Through ausplotsR, users can: (1) directly obtain plot-based data on vegetation and soils across Australia, and (2) preprocess these data into structures that facilitate the visualisation and analysis of ausplots data. Data preprocessing includes the computation of species occurrence, vegetation cover, growth form, and basal area. 

In this section of the workshop we will cover the following aspects:

1. ACCESSING AND INSTALLING THE `ausplotsR` PACKAGE (plus its Dependencies).

2. OBTAIN & EXPLORE AusPlots DATA: `get_ausplots` function:
  * `get_ausplots` function
  * Explore the structure of the obtained AusPlots data.

3. MANIPULATING AusPlots DATA:
  * Find the 5 most sampled Bioregions. 
  * Subset sites in the 5 most sampled Bioregions (in all DFs in the list)
  
4. MAP THE SITES
  * Obtain and prepare a map of Australia
  * Plot AusPlots sites in the 5 most sampled Bioregions on the map of Australia.
  
5. SPECIES-LEVEL DATA: `species_table` function and species occurrence matrices (for the 5 most sampled Bioregions).
  * First step: Create a species occurrence matrix. Compute Species by Site table using the function `species_table`
  * Species Abundance/Percent Cover:
    * Percent Cover (Abundance) by Site Visit x Species (i.e. in all 'cells')
    * Abundance (Cover %) by Species. Find and plot 4 most abundant species on a map (dot size proportional to Abundance).
  * Species Diversity: 
    * Calculate various indices and create a data frame with these indices.
    * Plot 2 indices: Species Richness (from vouchers, more species recorded), and Shannon Index (from veg.PI for abundances) on a map (dot size proportional to the relevant diversity metric) .


6. PROPORTIONAL VEGETATION COVER (= FRACTIONAL COVER): `fractional_cover' function.     

  * Latitudinal pattern in proportional vegetation cover (for a random subset of 200 sites).

7. GROWTH FORM: `growth_form_table` function (for 5 most sampled bioregions)
  * Plant Growth Forms Percent Cover against Sites : Compute using `growth_form_table`
  * Cluster (Hierarchical Clustering) by Plant Growth Forms Percent Cover, colour branches by bioregion. 
  
8. BASAL AREA (OR NUMBER OF BASAL WEDGE HITS): `basal_area` function (for 5 most sampled bioregions).
  * Basal Area for each plot (m2/ha): Compute using `basal_area`.
  * Display Basal Areas on map of Australia (dots size proportional to Basal Area).
  * Boxplot of Basal Areas by Bioregion. 



### ACCESSING AND INSTALLING THE `ausplotsR` PACKAGE (plus its Dependencies)

The package `ausplotsR` can be installed directly from github using the 'devtools' package, which must have been previously installed. The GitHub site for the package contains the latest developments and information on `ausplotsR`; it can be found in [this link](https://github.com/GregGuerin/ausplotsR).

```{r, message=FALSE, warning=FALSE, error=FALSE}

## Install directly from github using the 'devtools' package
## Thus, 'devtools' must be previouly installed
#install.packages("devtools", repos="https://cloud.r-project.org/")
#library(devtools)
#install_github("GregGuerin/ausplotsR", build_vignettes = TRUE)

## Load the package
#library(ausplotsR)

## Obtaining Help and Initial Steps
#help(ausplotsR)
#browseVignettes(package="ausplotsR")
```

Perhaps you also need to install the other packages required for this section of the workshop. A list of Compresenhive R Archive Network (CRAN) mirror URLs can be found [here](https://cran.r-project.org/mirrors.html). 

```{r, message=FALSE, warning=FALSE, error=FALSE}

## Select the repository (i.e. CRAN mirror URL)
#my.repos = "https://cloud.r-project.org/"
#my.repos = "https://cran.csiro.au/"

## Install other required libraries
#install.packages(c("ausplotsR", "vegan", "goeveg", "maps", "maptools", "mapdata", "sp",                        ggplot2", "gridExtra", "ggspatial", "dendextend"), repos=my.repos)
```

Before proceeding any further we load the other libraries that we will need for the workshop

```{r, message=FALSE, warning=FALSE, error=FALSE}
# Load packages
library(ausplotsR)  # If not loaded above
library(vegan)
library(goeveg)

library(maps)
library(maptools)
library(mapdata)
library(sp)
library(ggplot2)
library(gridExtra)
#library(ggspatial)

library(dendextend)
```




###  OBTAIN & EXPLORE AusPlots DATA: `get_ausplots` function

This function extracts and compiles AusPlots data. 

Up to 8 different types of data can be obtained by setting the corresponding arguments to TRUE/FALSE:

  * `site_info`: Site summary data. Includes (among others): plot and visit details, landform data, geographic coordinates, and notes. Included by default. 
  * `structural_summaries`: Site vegetation structural summaries
  * `veg.vouchers`: Complete set of species records for the plot determined by a herbarium plus ID numbers for silica-dried tissue samples. Included by default.
  * `veg.PI`: Point Intercept (PI) data. Includes data on: substrate, plant species, growth form and height, etc at each of (typically) 1010 points per plot. Included by default.
  * `basal.wedge`: Basal Wedge Data Raw Hits. These data are required for the calculation of Basal Area by Species by Plot.
  * `soil_subsites`: Information on what soil and soil metagenomics samples were taken at nine locations across the plot and their identification barcode numbers. 
  * `soil_bulk_density`: 
  * `soil_character`: Soil characterisation and sample ID data at 10 cm increments to a depth of 1 m.

In addition AusPlot data can be subset via the `get_ausplots` function arguments in two other ways:

  * `my.Plot_IDs`: Character vector with the plots IDs of specific AusPlots plots. 
  * `bounding_box`: Spatial filter for selecting AusPlots based on a rectangular box, in the format of e.g. c(xmin, xmax, ymin, ymax). AusPlots spatial data are are in longlat, thus x is the longitude and y is the latitude of the box/extent object (e.g., c(120, 140, -30, -10)). 

The R object resulting from calling `get_ausplots` is a list of data frames containing the requested AusPlots data. The list includes a data frame for each type of data requested (i.e. up to 8 data frames: 'site_info', 'structural_summaries',...). These data frames are interrelated and they all have a common variable, `site_location_name`. In each data frame the columns correspond to the variables supplied for each type of data and the number of rows (directly or indirectly) depends on the sites retrieved (e.g. via `my.Plot_IDs` or `bounding_box`).

```{r, message=FALSE, warning=FALSE, error=FALSE}


# Example 1: All available data for 3 plots
# ==========================================

# Obtain the data ('site_info', 'veg.vouchers', and 'veg.PI' are retraived by default)
AP.data = get_ausplots( my.Plot_IDs=c("SATFLB0004", "QDAMGD0022", "NTASTU0002"),
	                    structural_summaries=TRUE, basal.wedge=TRUE,
						          soil_subsites=TRUE, soil_bulk_density=TRUE, soil_character=TRUE  )

# Explore retrieved data
class(AP.data)
summary(AP.data)
str(AP.data)


# Example 2: Default data for a particular Geographic Extent
# ==========================================================

# 'site_info', 'veg.vouchers', and 'veg.PI' data retrived for Brisbane (27.4698S, 153.0251E) and its sourrounding area
AP.data = get_ausplots(bounding_box=c(152.5, 153.5, -28, -27))

# Explore retrieved data
#class(AP.data)   # As in Example 1 (can run uncommented if curious) 
summary(AP.data)
#str(AP.data)   # Similar to Example 1 (can run uncommented if curious) 


# Example 3: 'site_info', 'veg.PI', and 'basal.wedge' data for al sites
# =====================================================================

# Retreive data
start.time = Sys.time()
AP.data = get_ausplots(veg.vouchers=FALSE, basal.wedge=TRUE) 
end.time = Sys.time()
end.time - start.time

# Explore 
#class(AP.data)   # As in Example 1 (can run uncommented if curious) 
summary(AP.data)
#str(AP.data)   # Similar to Example 1 (can run uncommented if curious) 

# Explore 'site_info' data
dim(AP.data$site.info)
names(AP.data$site.info)
head(AP.data$site.info)

# Explore 'veg_PI' data
dim(AP.data$veg.PI)
names(AP.data$veg.PI)
head(AP.data$veg.PI)
```


### MANIPULATING AusPlots DATA

The retrieved data by the function 'get_ausplots' can be manipulated as any other R data. However, the 'deep' structure of the data and interrelation of the data frames (via the common `site_loation_name` variable) can make manipulating the data a bit more daunting. 

As an example, we will focus on the sites in the 5 most sampled Bioregions. We will first identify which are these regions, and then subset the sites in these regions. 

```{r, message=FALSE, warning=FALSE, error=FALSE}
#----------------------------------------------------------------------------------------
# Find the 5 most 'sampled' Bioregions
#----------------------------------------------------------------------------------------

# Create a derived Bioregions Factor Variable in the 'site.info' DF
AP.data$site.info$bioregion.f = factor(AP.data$site.info$bioregion_name)
#names(AP.data$site.info)

# Display the Bioregions number of visits (from most visited to least visited)
sort(summary(AP.data$site.info$bioregion.f), decreasing=TRUE)

# Get the Names of the 5 most visited Bioregions
Bioregs.Top5.s = names(sort(summary(AP.data$site.info$bioregion.f), decreasing=TRUE)[1:5])
Bioregs.Top5.s



#----------------------------------------------------------------------------------------
# Subset data for the 5 most 'visited/sampled' Bioregions 
#----------------------------------------------------------------------------------------

summary(AP.data)

# Subset the 5 most sampled Bioregions in the 'site.info' data frame
# ==================================================================
dim(AP.data$site.info)
AP.BioregTop5.l = AP.data
AP.BioregTop5.l$site.info = AP.BioregTop5.l$site.info[AP.BioregTop5.l$site.info$bioregion_name %in% Bioregs.Top5.s, ]
dim(AP.BioregTop5.l$site.info)

# Drop unused levels in the bioregion.f factor (i.e. the levels corresponding to other 
# bioregions are dropped). 
levels(AP.BioregTop5.l$site.info$bioregion.f)
AP.BioregTop5.l$site.info$bioregion.f = droplevels(AP.BioregTop5.l$site.info$bioregion.f)
levels(AP.BioregTop5.l$site.info$bioregion.f)

# Subset the 5 most sampled Bioregions in the 'veg.PI' data frame
# ===============================================================
dim(AP.BioregTop5.l$veg.PI)
AP.BioregTop5.l$veg.PI = AP.BioregTop5.l$veg.PI[AP.BioregTop5.l$veg.PI$site_location_name %in% AP.BioregTop5.l$site.info$site_location_name, ]
dim(AP.BioregTop5.l$veg.PI)

# Subset the 5 most sampled Bioregions in the 'veg.basal' data frame
# ==================================================================
dim(AP.BioregTop5.l$veg.basal)
AP.BioregTop5.l$veg.basal = AP.BioregTop5.l$veg.basal[AP.BioregTop5.l$veg.basal$site_location_name %in% AP.BioregTop5.l$site.info$site_location_name, ]
dim(AP.BioregTop5.l$veg.basal)

```

###  MAP THE SITES
  
Next we visualise the sites on a map of Australia. First we graph all the Sites curently in AusPlots and then the Sites in the 5 most sampled bioregions. To do so we first obtain the map from the `maps` package and convert it to `SpatialPolygons`. Then we plot the Sites on the SpatialPolygon object for the map of Australia using functions in the `ggplot2` package. To differenciate among bioregions, sites are represented by different shapes and colours in the first graph, and by dots of different colours in the second one. 

```{r, message=FALSE, warning=FALSE, error=FALSE, fig.height = 8, fig.width = 11.5}

#----------------------------------------------------------------------------------------
# Get and Prepare a Map of Australia
#----------------------------------------------------------------------------------------

# Maps in the package 'maps' are projected in longlat by default
aus = map("worldHires", "Australia", fill=TRUE, xlim=c(110,160),ylim=c(-45,-5), mar=c(0,0,0,0), plot=FALSE)

# Convert map data to SpatialPolygons
#aus.sp = map2SpatialPolygons(aus, IDs=aus$names, proj4string=CRS("+proj=longlat"))
CRS("+init=epsg:4326") # More info (i.e. provides a datum)
aus.sp = map2SpatialPolygons(aus, IDs=aus$names, proj4string=CRS("+init=epsg:4326"))


#----------------------------------------------------------------------------------------
# Plot All AusPlots Sites on a Map of Australia
#----------------------------------------------------------------------------------------
ggplot( data=AP.data$site.info, 
		     aes(x = longitude, y = latitude, group=bioregion.f), alpha =0.5) + 
geom_point(aes(colour=bioregion.f, fill=bioregion.f, shape=bioregion.f), size=1.5) + 
scale_shape_manual(values=rep(c(15:18,3:4,8),7)) +  # Cycle through Symbol Types 
ggtitle("Locations of all AusPlots sites") + 
theme(plot.title = element_text(hjust = 0.5, face="bold", size=14)) +
geom_polygon(data=fortify(aus.sp), aes(x=long, y=lat, group=group), col="black", fill=NA)


#----------------------------------------------------------------------------------------
# Plot AusPlots sites in the 5 Bioregions on Map of Australia
#----------------------------------------------------------------------------------------
ggplot(data=AP.BioregTop5.l$site.info, aes(x = longitude, y = latitude, colour=bioregion.f, fill=bioregion.f), alpha =0.5) + 
geom_point(pch=21, size=1.5) + scale_colour_manual(values = c("darkgreen", "magenta", "red", "yellow", "cyan")) +
scale_fill_manual(values = c("darkgreen", "magenta", "red", "yellow", "cyan")) +
ggtitle("Locations of sites in the 5 most sampled bioregions") + 
theme(plot.title = element_text(hjust = 0.5, face="bold", size=14)) +
geom_polygon(data=fortify(aus.sp), aes(x=long, y=lat, group=group), col="black", fill=NA)

```


### SPECIES-LEVEL DATA: `species_table` function and species occurence matrices 

 In this section, we will explore to how to obtain and use species occurrence data from AusPlots raw data. In particular, we will examine species cover/abundance, species presence/absence, multiple indices of species diversity, and rank-abundance plots for the sites in the 5 most sampled bioregions. 

#### First step: Create a species occurence matrix

 The first step to work with species-level AusPlots data is to create a species occurrence matrix. The `species_table` function in the `ausplotsR` package can be used to effortlessly create this type of matrix. This function takes a data frame of individual raw point intercept hits (i.e. a `veg.PI` data frame) generated using the `get_ausplots` function and returns a 'species against sites' matrix. Four metrics can be selected to score species occurrence: 
 
  * _Presence/Absence_ (argument `m_kind = PA`).
  * _Percent Cover_: Based on total frequency of hits. This is the most commonly used metric  (argument `m_kind = percent_cover`).
  * _Frequency_: Based on proportional frequencies of presence on the 10 individual transects within a plot  (argument `m_kind = freq`). It can be a measure of importance for low cover species.
  * _IVI_: A combination of cover and frequency  (argument `m_kind = IVI`).

 If Percent Cover or IVI are used two types of cover type can be selected:
 
  * _Projected Foliage Cover_ (_PFC_):Hits scored as 'in canopy sky' are removed  (argument `cover_type = PFC`). 
  * _Opaque Canopy Cover_ (_OCC_): Hits scored as 'in canopy sky' are retained  (argument `cover_type = OCC`). 

 
```{r, message=FALSE, warning=FALSE, error=FALSE}
# Use function 'species_table' in 'ausplotsR' package to create an Abundance per Site Table
# =========================================================================================
SppBYSites.BioregTop5 = species_table(AP.BioregTop5.l$veg.PI, m_kind="percent_cover",                                            cover_type="PFC")
class(SppBYSites.BioregTop5)
dim(SppBYSites.BioregTop5) # Number of rows and columns in the matrix: 574 Sites x 3024 Spp
SppBYSites.BioregTop5[1:5, 1:5]

# Enrich Table with: Site_Location, Bioregion, Latitude, and Longitude
# ====================================================================

# Create a site_visit variable in original dataset to relate both datasets
# -------------------------------------------------------------------------
AP.BioregTop5.l$site.info$Plot =  paste(AP.BioregTop5.l$site.info$site_location_name, 
								        AP.BioregTop5.l$site.info$site_location_visit_id, sep="-")	
SppBYSites.BioregTop5$Plot = rownames(SppBYSites.BioregTop5)										

# Both DF have differente number of rows!
dim(SppBYSites.BioregTop5)
dim(AP.BioregTop5.l$site.info) 

# Enrich with: Bioregion, Latitude, and Longitude								
# -----------------------------------------------
SppBYSites.BioregTop5  = merge(SppBYSites.BioregTop5, AP.BioregTop5.l$site.info,                                          by="Plot")[,c(names(SppBYSites.BioregTop5), 
                                          "bioregion.f", "longitude", "latitude")]
SppBYSites.BioregTop5 = na.omit(SppBYSites.BioregTop5)
#head(SppBYSites.BioregTop5)
#summary(SppBYSites.BioregTop5)
head(names(SppBYSites.BioregTop5))
```

#### Species Abundance

 In AusPlots data percent cover is used as a measure of abundance. In this section, we will examine percent cover by:

  * Site visit and species: That is, all cells in the 'Species by Sites' table. 
  * Species: By computing the column totals in the 'Species by Sites' table. 

#####  Percent Cover (Abundance) by Site Visit x Species

```{r, message=FALSE, warning=FALSE, error=FALSE, fig.height = 8, fig.width = 11}

# Minimum and Maximum Site Visit x Species Abundance values
# ---------------------------------------------------------
# '-4' because we added 4 new columns (Plot, bioregion.f, longitude, and latitude)##
range(SppBYSites.BioregTop5[,1: (dim(SppBYSites.BioregTop5)[2]-4)])

# Plot Highest  Site Visit x Species Abundance values
# ---------------------------------------------------
Abundance = unlist(SppBYSites.BioregTop5[,1: (dim(SppBYSites.BioregTop5)[2]-4)])
head(Abundance)
#length(Abundance)
#dim(SppBYSites.BioregTop5)

# Plot the 5 Site Visits x Species combination with the Highest Abundances
par(mfrow=c(1,1))
barplot(sort(Abundance, decreasing=TRUE)[1:5], las=1, xlab="Abundance class", ylab="Frequency")

# ggplot2 graph to make it look nicer. Now we plot the 25 species-site visit covers with horizontal bars
temp.labs = names(sort(Abundance, decreasing=TRUE))
temp.Abundances = sort(Abundance, decreasing=TRUE)
temp.df = data.frame(temp.Abundances, temp.labs)
# Order factor levels so that bars are sorted by Abundance in the plot. Otherwise they would plotted in alphabetical order
# 'rev' to plot bars in decreasing order (i.e. larger bar at top; otherwise larger bar at bottom)
temp.df$temp.labs = factor(temp.df$temp.labs, levels=rev(temp.df$temp.labs))
ggplot(data=temp.df[1:25,], aes(x=temp.labs, y=temp.Abundances)) + 
geom_bar(stat="identity", fill="steelblue") +
geom_text(aes(label=round(temp.Abundances,2)), hjust=-0.1, size=4)+
labs(x="Species & Site Visit", y="Abundance (Cover %)") + 
theme_minimal() + coord_flip()
# Cleaning up
rm(list=ls(pattern="temp."))
```


#####  Abundance (Cover %) by Species

Now we compute the percent cover of all species across the sites in the 5 most sampled bioregions. Then we find and plot on a map of Australia the 4 most Abundant species in the 
5 regions (across all regions pooled together).

```{r, message=FALSE, warning=FALSE, error=FALSE, fig.height = 8, fig.width = 11.5}

# Compute Species Total Abundance (Cover %)
# -----------------------------------------
TotAbundances.BioregTop5 = colSums(SppBYSites.BioregTop5[,1:(dim(SppBYSites.BioregTop5)[2]-4)])
head(TotAbundances.BioregTop5)

# Species with Highest Total Abundance 
# ------------------------------------
# Species with Highest Total Abundance
max(TotAbundances.BioregTop5)
which.max(TotAbundances.BioregTop5)
# Species with Top 4 Highest Abundances
TotAbundances4Highest.indices = 
     which(TotAbundances.BioregTop5 >= sort(TotAbundances.BioregTop5, decreasing=T)[4],               arr.ind=T)
sort(TotAbundances.BioregTop5[TotAbundances4Highest.indices], decreasing=TRUE)

# Plot 4 Species with Highest Cover in the 5 Most Sampled Bioregions
# ------------------------------------------------------------------

# Most Abundant Species 
spp = names(sort(TotAbundances.BioregTop5[TotAbundances4Highest.indices],                                   decreasing=TRUE))[1]
plot.title =  paste(spp, " (total cover over the 5 bioregions = ", 
                    round(sort(TotAbundances.BioregTop5[TotAbundances4Highest.indices],                                   decreasing=TRUE)[1],2) , ")", sep="")
TotAbundance.spp1 = 
ggplot(data=SppBYSites.BioregTop5, aes(x=longitude, y=latitude, colour=bioregion.f, fill=bioregion.f), alpha =0.5) + 
geom_point(aes_string(size=spp), pch=21) + 
scale_colour_manual(values = c("darkgreen", "magenta", "red", "yellow", "cyan")) +
scale_fill_manual(values = c("darkgreen", "magenta", "red", "yellow", "cyan")) +
ggtitle(plot.title) + theme(plot.title = element_text(hjust = 0.5)) +			 
geom_polygon(data=fortify(aus.sp), aes(x=long, y=lat, group=group), col="black", fill=NA) 

# 2nd Most Abundant Species 
spp = names(sort(TotAbundances.BioregTop5[TotAbundances4Highest.indices],                                   decreasing=TRUE))[2]
plot.title =  paste(spp, " (total cover over the 5 bioregions = ", 
                    round(sort(TotAbundances.BioregTop5[TotAbundances4Highest.indices],                              decreasing=TRUE)[2],2) , ")", sep="")
TotAbundance.spp2 = 
ggplot(data=SppBYSites.BioregTop5, aes(x=longitude, y=latitude, colour=bioregion.f, fill=bioregion.f), alpha =0.5) + 
geom_point(aes_string(size=spp), pch=21) + 
scale_colour_manual(values = c("darkgreen", "magenta", "red", "yellow", "cyan")) +
scale_fill_manual(values = c("darkgreen", "magenta", "red", "yellow", "cyan")) +
ggtitle(plot.title) + theme(plot.title = element_text(hjust = 0.5)) +			 
geom_polygon(data=fortify(aus.sp), aes(x=long, y=lat, group=group), col="black", fill=NA)

# 3rd Most Abundant Species 
spp = names(sort(TotAbundances.BioregTop5[TotAbundances4Highest.indices],                                   decreasing=TRUE))[3]
plot.title =  paste(spp, " (total cover over the 5 bioregions = ", 
                    round(sort(TotAbundances.BioregTop5[TotAbundances4Highest.indices],                              decreasing=TRUE)[3],2) , ")", sep="")
TotAbundance.spp3 = 
ggplot(data=SppBYSites.BioregTop5, aes(x=longitude, y=latitude, colour=bioregion.f, fill=bioregion.f), alpha =0.5) + 
geom_point(aes_string(size=spp), pch=21) + 
scale_colour_manual(values = c("darkgreen", "magenta", "red", "yellow", "cyan")) +
scale_fill_manual(values = c("darkgreen", "magenta", "red", "yellow", "cyan")) +
ggtitle(plot.title) + theme(plot.title = element_text(hjust = 0.5)) +			 
geom_polygon(data=fortify(aus.sp), aes(x=long, y=lat, group=group), col="black", fill=NA)

# 4th Most Abundant Species 
spp = names(sort(TotAbundances.BioregTop5[TotAbundances4Highest.indices],                              decreasing=TRUE))[4]
plot.title =  paste(spp, " (total cover over the 5 bioregions = ", 
                    round(sort(TotAbundances.BioregTop5[TotAbundances4Highest.indices],                              decreasing=TRUE)[4],2) , ")", sep="")
TotAbundance.spp4 = 
ggplot(data=SppBYSites.BioregTop5, aes(x=longitude, y=latitude, colour=bioregion.f, fill=bioregion.f), alpha =0.5) + 
geom_point(aes_string(size=spp), pch=21) + 
scale_colour_manual(values = c("darkgreen", "magenta", "red", "yellow", "cyan")) +
scale_fill_manual(values = c("darkgreen", "magenta", "red", "yellow", "cyan")) +
ggtitle(plot.title) + theme(plot.title = element_text(hjust = 0.5)) +			 
geom_polygon(data=fortify(aus.sp), aes(x=long, y=lat, group=group), col="black", fill=NA)

# Plot the 4 Graphs
grid.arrange(TotAbundance.spp1, TotAbundance.spp2, TotAbundance.spp3, TotAbundance.spp4, nrow=2)

```


#### Species Diversity

  On our exploration of the use of Species-lelvel AusPlots data, we now focus on Species Diversity. We first compute 7 common diversity indices, which we then place in a dataset. Finally, as an example, we plot two of these indices (Species Richness and Shanon Diversity Index) for the sites in the 5 most sampled bioregions on a map of Australia. 
  
NOTE: Diversity indices were originally designed to be used with counts of number of individuals per species, rather than percent cover, as a measure of abundance. These indices are also used with percent cover in the literature (see Tomasckik and Sander, 1987 for an example using coral cover). We need, however, to be aware of the different kind of answers and interpretation of the results required. 


```{r, message=FALSE, warning=FALSE, error=FALSE, fig.height = 8, fig.width = 14}

# Compute and place in a DF the Species Diversity Indices
# =======================================================

# Species Richness
N0 = rowSums(SppBYSites.BioregTop5[,1:(dim(SppBYSites.BioregTop5)[2]-4)] > 0)
# Shannon Entropy
H = diversity(SppBYSites.BioregTop5[,1:(dim(SppBYSites.BioregTop5)[2]-4)])
# Shannon Diversity Index
N1 = exp(H)
# Simpson Diversity Index
N2 = diversity(SppBYSites.BioregTop5[,1:(dim(SppBYSites.BioregTop5)[2]-4)], "inv")
# Shannon Evenness (Hill's ratio)
E1 = N1/N0
# Simpson Evenness (Hill's ratio)
E2 = N2/N0
# Pielou Evenness
J = H/log(N0)

# Create a Data Frame with the Species Diversity Indices
SppBYSites.BioregTop.Div.df = data.frame(N0, H, N1, N2, E1, E2, J)


# Map Species Richness and Shannon Diversity Index (as an example)
# ================================================================

# Add extra info to DataFrame (Bioregions, longitude, and latitude)
SppBYSites.BioregTop.Div.df$bioregion.f = SppBYSites.BioregTop5[rownames(SppBYSites.BioregTop.Div.df),"bioregion.f"]
SppBYSites.BioregTop.Div.df$longitude = SppBYSites.BioregTop5[rownames(SppBYSites.BioregTop.Div.df),"longitude"]
SppBYSites.BioregTop.Div.df$latitude = SppBYSites.BioregTop5[rownames(SppBYSites.BioregTop.Div.df),"latitude"]
summary(SppBYSites.BioregTop.Div.df) 

# Create Species Richness Plot
Div.SR = 
ggplot(data=SppBYSites.BioregTop.Div.df, aes(x=longitude, y=latitude, colour=bioregion.f, fill=bioregion.f), alpha =0.5) + 
geom_point(aes_string(size=N0), pch=21) + 
scale_colour_manual(values = c("darkgreen", "magenta", "red", "yellow", "cyan")) +
scale_fill_manual(values = c("darkgreen", "magenta", "red", "yellow", "cyan")) +
geom_polygon(data=fortify(aus.sp), aes(x=long, y=lat, group=group), col="black", fill=NA)

# Create Shanon Diversity Index Plot
Div.ShannonIndex = 
ggplot(data=SppBYSites.BioregTop.Div.df, aes(x=longitude, y=latitude, colour=bioregion.f, fill=bioregion.f), alpha =0.5) + 
geom_point(aes_string(size=N1), pch=21) + 
scale_colour_manual(values = c("darkgreen", "magenta", "red", "yellow", "cyan")) +
scale_fill_manual(values = c("darkgreen", "magenta", "red", "yellow", "cyan")) +
geom_polygon(data=fortify(aus.sp), aes(x=long, y=lat, group=group), col="black", fill=NA)

# Plot the 2 graphs
grid.arrange(Div.SR, Div.ShannonIndex, ncol=2)
```


### PROPORTIONAL VEGETATION COVER (= FRACTIONAL COVER): `fractional_cover' function

 Fractional Cover (FC) is the proportional cover of green vegetation, dead vegetation and bare substrate, based on plot-based point intercept data from AusPlots (as generated by 'get_ausplots'). 

 Cover fractions are assigned according to the following: 
 
 * 'Green' or 'photosynthetic vegetation' is living vascular plant cover. 
 * 'Brown' or 'non-photosynthetic vegetation' is either vascular plant cover scored as 'dead' or substrate scored as litter, coarse woody debris or cryptogam (see below) that has no other veg cover. 
 * 'Bare' or 'bare ground' is substrate that is rock, outcrop, gravel or bare soil with no veg cover. 

 A height rule is applied so that coding to green/brown/bare of the uppermost substrate/vegetation stratum hit at a given point intercept location overrides the others, that is, a dead tree overrides a living shrub beneath and vice versa; substrate coding is overridden by any vegetation cover etc. This means for each of the (usually) 1010 intercepts, there is a single coding and percentage is the number of hits assigned to each fraction, divided by the total number of PIs taken (usually 1010 but can vary) times 100. 

 There is an option via argument 'ground_fractional' to calculate fractional ground cover - the same concept applied to only grasses (hummock, tussock, other); sedge; rush; forb; fern; and vine plant growth forms. Presently, cryptogam cover is excluded and included in the non-photosynthetic fraction. 

 'In canopy sky' is excluded by default (only the substrate is considered for those hits) and applies only to regular fractional cover (as trees are excluded in the green fraction for ground fractional cover by default). 

 Currently, cryptogam substrate is assigned to the non-photosynthetic fraction. 

 Occasionally substrate type was not collected ('NC') or could not be assigned to one of the above categories ('Unknwn'), in which case a percent cover will be returned under an 'NA' fraction if there was no veg cover above those points. 

 The function `fractional_cover`returns a data frame in which plots are rows, columns are fractions (bare, brown, green and NA) and values are percent cover. 


 In this section we will explore: 
 
  * The Latitudinal Pattern in Proportional Vegetation Cover (for a random subest of 200 sites).
  * Temporal Variation in fractional cover: Explore, display, and assess (for 5 sites visited twice).


#### Latitudinal Pattern in Proportional Vegetation Cover

 In this seection we will follow these steps:
 
 * Call the `fractional_cover` function on the extracted point intercept data. This calculation may take a few minutes for all AusPlots, so for this example we will work with a random subset of 200 randomly drawn sites.
 * Plot the Latitudinal Pattern in Proportional Vegetation Cover (here we use the 'Proportion of Bare Ground'). To do this, we first enrich the dataset with additional variables including: 'Plot' (identifier for each Site-Visit combination), 'bioregion.f', 'longitude', and 'latitude'. 
 * Fit a Quadratic Model to the data and examine its Fit, as there appears to be a humpbacked relationship in the previous plot (higher proportionof bare ground in the arid inland at mid-latitudes). 

```{r, message=FALSE, warning=FALSE, error=FALSE, fig.height = 8, fig.width = 11.5}

# First, we call the fractional_cover function on the extracted point intercept data. 
# NOTE: Calculation may take a few minutes for all AusPlots, so for this example 
# we will pull out a subset of 200 randomly drawn sites to work with. 
# The sets site composition will differ each time the script is run, 
# as they are random subsets. 

# Compute Fractional Cover using function 'fractional_cover`
# ---------------------------------------------------------
AP.200Locs.FC =
fractional_cover(AP.data$veg.PI[AP.data$veg.PI$site_location_name %in% 
				                sample(AP.data$site.info$site_location_name, 200), ])
#AP.200Locs.FC = na.omit(AP.200Loc.FC)
head(AP.200Locs.FC)


# Create a site_visit variable in original dataset to relate both datasets
# ------------------------------------------------------------------------
AP.data$site.info$Plot =  paste(AP.data$site.info$site_location_name, 
								AP.data$site.info$site_location_visit_id, sep="-")	
  # Enrich with: Bioregion, Latitude, and Longitude								
AP.200Locs.FC  = merge(AP.200Locs.FC, AP.data$site.info, by="Plot")[,c("Plot", "bare", "brown", "green", "NA.", "bioregion.f", "longitude", "latitude")]
AP.200Locs.FC = na.omit(AP.200Locs.FC)
head(AP.200Locs.FC)
summary(AP.200Locs.FC)
names(AP.200Locs.FC)


# Plot out the continental relationship between Fractional Cover 
# --------------------------------------------------------------
# Here we use the 'Proportion of Bare Ground' & Latitude

# Plot the relationship between Proportion of Bare Ground (with no kind of vegetation cover above) and Latitude.
par(mfrow=c(1,1))
plot(bare ~ latitude, data=AP.200Locs.FC, pch=20, bty="l")


# Quadratic LM of Continental Relationship between Bare Ground Fractional Cover & Latitude
# ----------------------------------------------------------------------------------------

# Fit & Examine as Quadratic Linear Model the Continental Relationship between Bare Ground Fractional Cover & Latitude
AP.200Locs.FC.lm = lm(bare ~ latitude + I(latitude^2), data=AP.200Locs.FC)
summary(AP.200Locs.FC.lm)

# Predict values from Model Fit
pred.df = data.frame(latitude=seq(from=min(AP.200Locs.FC$latitude), to=max(AP.200Locs.FC$latitude), length.out=50))
pred.df$pred = predict(AP.200Locs.FC.lm, pred.df)

# Plot Predicted Values from Model Fit on Graph with Continental Relationship between Bare Ground Fractional Cover & Latitude
plot(bare ~ latitude, data=AP.200Locs.FC, pch=20, bty="n")
points(pred.df$latitude, pred.df$pred, type="l", lwd=2, col="darkblue")

```


### GROWTH FORM: `growth_form_table` function (for 5 most sampled bioregions)

The `growth_form_table` function in the `ausplotR` package can be  used to generate occurrence matrices for NVIS plant growth forms in plots. The input for this function is a data frame of raw point intercept AusPlots data generated using the `get_ausplots` function. Three metrics can be selected to score species growth form: 

  * _Presence/Absence_ (argument `m_kind = PA`).
  * _Percent Cover_: Based on total frequency of hits (argument `m_kind = percent_cover`). This is the most useful and commonly used metric. It can be subsequently used in statistical analyses (e.g. MANOVA, Ordination, Classification, etc.)at continental scale where species turnover is too high for some methods to provide meaningful results. 
  * _Species Richness_: (argument `m_kind = richness`). Note that when m_kind is set to "richness" the `rowSums` of the occurrence matrix can be higher than the observed SR because sometimes the same species is recorded with different growth forms in a plot and therefore the same species can count towards the weights for multiple growth forms.

 If Percent Cover is used two types of cover type can be selected:
 
  * _Projected Foliage Cover_ (_PFC_):Hits scored as 'in canopy sky' are removed  (argument `cover_type = PFC`). 
  * _Opaque Canopy Cover_ (_OCC_): Hits scored as 'in canopy sky' are retained  (argument `cover_type = OCC`). 

 In this section we will:
 * Generate a Plant Growth Forms Percent Cover against Sites Matrix using the  `growth_form_table` function. 
 * Enrich this Matrix with additional information (plot -site-visit-, bioregion, longitude, and latitude).
 * Compute Summary Statics for each of the Growth Forms in the 5 most sampled Bioregions (slightly different to those produce by the `summary` function in the `base` package.
 * Cluster (Hierachical Clustering) the Sites-Visits by Plant Growth Forms Percent Cover, colouring the resulting tree branches by bioregion.

CLUSTERING RESULTS:
 * The first Site-Visit (NTAGFU0007-53654) is very different to the rest
 * The dendrogram shows clusters formed by single Bioregions at low level; however, at higher-level clusters are composed by Sites-Visits from different Bioregions. 


```{r, message=FALSE, warning=FALSE, error=FALSE, fig.height = 8, fig.width = 11.5}

# Generate the Growth Form by Site-Visit Matrix
# =============================================
AP.BRTop5.GrowthFormBYSites = growth_form_table(AP.BioregTop5.l$veg.PI,                                                        m_kind="percent_cover", cover_type="PFC")  # % Cover
dim(AP.BRTop5.GrowthFormBYSites) # No of rows and cols in Matrix: 574 Sites x 19 Growth Forms
head(AP.BRTop5.GrowthFormBYSites)


# Enrich DF
# =========

# Add Plot (Site-Vist)
# --------------------
AP.BRTop5.GrowthFormBYSites$Plot = rownames(AP.BRTop5.GrowthFormBYSites)	

# Add: Bioregion, Longitude, Latitude
# -----------------------------------
# Both DF have different number of rows (again!)
dim(AP.BRTop5.GrowthFormBYSites)
dim(AP.BioregTop5.l$site.info) 


# Enrich with: Bioregion, Latitude, and Longitude								
AP.BRTop5.GrowthFormBYSites  = merge(AP.BRTop5.GrowthFormBYSites, AP.BioregTop5.l$site.info, by="Plot")[,c(names(AP.BRTop5.GrowthFormBYSites), 
																							"bioregion.f", "longitude", "latitude")]
AP.BRTop5.GrowthFormBYSites = na.omit(AP.BRTop5.GrowthFormBYSites)
#head(AP.BRTop5.GrowthFormBYSites)
summary(AP.BRTop5.GrowthFormBYSites)
names(AP.BRTop5.GrowthFormBYSites)

# Summary Statistics for Each Growth Form
# =======================================
AP.BRTop5.GFBYSites.DescStats = data.frame(
  Min = apply(AP.BRTop5.GrowthFormBYSites[,1: (dim(AP.BRTop5.GrowthFormBYSites)[2]-4)], 2,               min), # Minimum
  Med = apply(AP.BRTop5.GrowthFormBYSites[,1: (dim(AP.BRTop5.GrowthFormBYSites)[2]-4)], 2,               median), # Median
  Max = apply(AP.BRTop5.GrowthFormBYSites[,1: (dim(AP.BRTop5.GrowthFormBYSites)[2]-4)], 2,               max), # Maximum
  Mean = apply(AP.BRTop5.GrowthFormBYSites[,1: (dim(AP.BRTop5.GrowthFormBYSites)[2]-4)], 2,                mean), # Mean
  SD = apply(AP.BRTop5.GrowthFormBYSites[,1: (dim(AP.BRTop5.GrowthFormBYSites)[2]-4)], 2,               sd) # Standard Deviation
  )
AP.BRTop5.GFBYSites.DescStats = round(AP.BRTop5.GFBYSites.DescStats, 2)
AP.BRTop5.GFBYSites.DescStats


# Create and Plot a Dendogram of the Sites-Visits Clustered by Growth Forms
# =========================================================================

# Add rownames to be used as Leaves Names
rownames(AP.BRTop5.GrowthFormBYSites) = AP.BRTop5.GrowthFormBYSites$Plot

# Create Dendogram
AP.BRTop5.GFBYSites.dend = as.dendrogram(hclust(dist(AP.BRTop5.GrowthFormBYSites[,1: (dim(AP.BRTop5.GrowthFormBYSites)[2]-4)]), "average"))

# Color the Leaves by Bioregion
# NOTE: The most sampled bioregions might change as new data is added. If so, bioregions codes bellow should be revised.
# Here the codes correspond to: MDD (Murry Darling Depression), SSD (Simpson 
# Strzelecki Dunefields), GFU (Gulf Fall and Uplands), STP (Stony Plains), 
# PIL (Pilbara)
AP.BRTop5.GrowthFormBYSites$bioregion.col.f = AP.BRTop5.GrowthFormBYSites$bioregion.f
levels(AP.BRTop5.GrowthFormBYSites$bioregion.col.f)[levels(AP.BRTop5.GrowthFormBYSites$bioregion.col.f) == "GFU"] = "darkgreen"
levels(AP.BRTop5.GrowthFormBYSites$bioregion.col.f)[levels(AP.BRTop5.GrowthFormBYSites$bioregion.col.f) == "MDD"] = "magenta"
levels(AP.BRTop5.GrowthFormBYSites$bioregion.col.f)[levels(AP.BRTop5.GrowthFormBYSites$bioregion.col.f) == "PIL"] = "red"
levels(AP.BRTop5.GrowthFormBYSites$bioregion.col.f)[levels(AP.BRTop5.GrowthFormBYSites$bioregion.col.f) == "SSD"] = "yellow"
levels(AP.BRTop5.GrowthFormBYSites$bioregion.col.f)[levels(AP.BRTop5.GrowthFormBYSites$bioregion.col.f) == "STP"] = "cyan"
dend.colors = as.character(AP.BRTop5.GrowthFormBYSites$bioregion.col.f)
#dend.colors
dend.colors = dend.colors[order.dendrogram(AP.BRTop5.GFBYSites.dend)]
#dend.colors
labels_colors(AP.BRTop5.GFBYSites.dend) = dend.colors
# Plot Dendrogram
plot(AP.BRTop5.GFBYSites.dend, 
     main="Dendogram of the Sites-Visits Clustered by Growth Forms, with leaves coloured by            Bioregion")
```



### BASAL AREA (OR NUMBER OF BASAL WEDGE HITS): `basal_area` function (for 5 most sampled bioregions).

 The `basal_area` function calculates the Basal Area (or Number of Basal Wedge Hits) for each plot, using the raw basal wedge data returned by the `get_ausplots` funcion also in the `ausplotsR` package. This function returns a data frame with rows representing Plots (or species by plots) and a single column containning the Basal Area (m2/ha) or Hit Scores. 

  In this section we will: 

  * Compute the Basal Area for each plot (m2/ha) using the `basal_area` function.
  * Enrich the data frame containing the Basal Area data with additional information (i.e. plot -Site-Visit-, bioregion, longitude, and latitude). 
  * Display Basal Areas on map of Australia (with Dots size proportional to Basal Area).
  * Boxplot of Basal Areas by Bioregion. 


```{r, message=FALSE, warning=FALSE, error=FALSE, fig.height = 8, fig.width = 8}


# Calculate Basal Area
# ====================
AP.BioregTop5.BA = basal_area(AP.BioregTop5.l$veg.basal)
summary(AP.BioregTop5.BA)
head(AP.BioregTop5.BA)


# Enrich DF
# =========
# Preparation
colnames(AP.BioregTop5.BA) 
colnames(AP.BioregTop5.BA)[1] = "Plot"  # Change the name to be able to Merge DFs
summary(AP.BioregTop5.BA)
head(AP.BioregTop5.BA)

# Add: Bioregion, Longitude, Latitude
# ----------------------------------
# Both DF have different number of rows (again!)
dim(AP.BioregTop5.BA)
dim(AP.BioregTop5.l$site.info) 

# Enrich with: Bioregion, Latitude, and Longitude								
AP.BioregTop5.BA  = merge(AP.BioregTop5.BA, AP.BioregTop5.l$site.info, by="Plot")[,c(names(AP.BioregTop5.BA), 
																							"bioregion.f", "longitude", "latitude")]
AP.BioregTop5.BA = na.omit(AP.BioregTop5.BA)
head(AP.BioregTop5.BA)
summary(AP.BioregTop5.BA)
names(AP.BioregTop5.BA)


# Graphical Visualisation
# =======================

# Map with circle size the Basal Area (m2/ha)
# -------------------------------------------
AP.BioregTop5.BA.p1 = 
ggplot(data=AP.BioregTop5.BA, aes(x=longitude, y=latitude, colour=bioregion.f, fill=bioregion.f), alpha =0.5) + 
geom_point(aes(size=basal_area_m2_ha), pch=21) + 
scale_colour_manual(values = c("darkgreen", "magenta", "red", "yellow", "cyan")) +
scale_fill_manual(values = c("darkgreen", "magenta", "red", "yellow", "cyan")) +
geom_polygon(data=fortify(aus.sp), aes(x=long, y=lat, group=group), col="black", fill=NA)

# Boxplot
# -------
AP.BioregTop5.BA.p2 = 
ggplot(AP.BioregTop5.BA, aes(x=bioregion.f, y=basal_area_m2_ha, color=bioregion.f)) + 
geom_boxplot() + 
scale_colour_manual(values = c("darkgreen", "magenta", "red", "yellow", "cyan")) +
scale_fill_manual(name="Bioregions (Top 5)", values = c("darkgreen", "magenta", "red", "yellow", "cyan")) +
labs(title="Basal Area per Bioregion",x="Bioregion (5 most sampled)", y = "Basal area (m^2/Ha)") + 
theme(plot.title = element_text(hjust = 0.5))

# Plot both graphs
# ----------------
grid.arrange(AP.BioregTop5.BA.p1, AP.BioregTop5.BA.p2, nrow=2)
#grid.arrange(AP.BioregTop5.BA.p1, AP.BioregTop5.BA.p2, ncol=2)

```

